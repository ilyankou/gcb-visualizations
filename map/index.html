<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Map</title>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="style.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
      integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
      integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
      crossorigin=""></script>

    <script src="zip-to-state.js"></script>

  </head>

  <body>
    <div id="map"></div>

    <script>

    function getField(name, fields) {
      for (i in fields) {
        if (fields[i][0] === name && fields[i][1]) {
          return i;
        }
      }
      return -1;
    }


    $.getJSON('../mobilecsp-2017/Student.json', function(json) {
      var places = {};

      var addPlace = function addPlace(p) {
        if (!places[p]) {
          places[p] = 1;
        } else {
          places[p] += 1;
        }
      }

      var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');

          if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
          }
        }
      };

      for (i in json.rows) {
        // Check if student was enrolled between start and end dates:
        var startDate = new Date(getUrlParameter('start'));
        var endDate = new Date(getUrlParameter('end'));
        var enrolledDate = new Date(json.rows[i].enrolled_on);

        if (startDate && enrolledDate < startDate) continue;
        if (endDate && enrolledDate > endDate) continue;

        var fields = JSON.parse(json.rows[i].additional_fields);

        var stateIndex = getField('state', fields);
        if (stateIndex > -1) {
          addPlace(fields[stateIndex][1]);
          continue;
        }

        var zipIndex = getField('zipcode', fields);
        if (zipIndex > -1) {
          var state = zipToState(fields[zipIndex][1]);
          if (state) {
            addPlace(state);
            continue;
          }
        }

        var countryIndex = getField('country', fields);
        if (countryIndex > -1) {
          addPlace(fields[countryIndex][1]);
          continue;
        }

        // If we reached this, user did not specify their location
        addPlace('Unknown');
      }

      createMap(places);
    });

    function createMap(places) {
      var map = L.map('map', {
          center: [39, -98],
          zoom: 4
      });

      var max = 1;
      var keys = Object.keys(places);
      for (k in keys) {
        if (places[keys[k]] > max) max = places[keys[k]];
      }

      var base = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', {
      	attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      	subdomains: 'abcd',
      	minZoom: 0,
      	maxZoom: 20,
      	ext: 'png'
      }).addTo(map);

      function getColor(d) {
        if (d == 0) return '#fff';
        if (d == 1) d = 0.99;
        var colors = ['f1eef6', 'bdc9e1', '74a9cf', '2b8cbe', '045a8d'];
        return '#' + colors[parseInt(d*5)];
      }

      function style(feature) {
        var name = feature.properties.NAME;
        if (!name) name = feature.properties.iso_a3;
        var val = places[name];
        if (!val) val = 0;
        return {color: getColor(val/max), stroke: 0, fillOpacity: 0.8};
      }

      function onEachFeature(feature, layer) {
        var name = layer.feature.properties.NAME; // US state
        var niceName = name;
        if (!name) {
          name = layer.feature.properties.iso_a3;
          niceName = layer.feature.properties.name;
        }

        var val = places[name];
        if (!val) val = 0;

        layer.bindPopup('<b>' + niceName + '</b> ' + val);
      }


      $.getJSON('usa.geojson', function(data) {
        var usMap = new L.geoJSON(data, {
          style: style,
          onEachFeature: onEachFeature,
        }).addTo(map);
      });

      $.getJSON('world.geojson', function(data) {
        var usMap = new L.geoJSON(data, {
          style: style,
          onEachFeature: onEachFeature,
        }).addTo(map);
      });

    }

    </script>
  </body>

</html>
