<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Map</title>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="style.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
      integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
      integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
      crossorigin=""></script>

    <script src="zip-to-state.js"></script>

  </head>

  <body>
    <div id="map"></div>

    <script>

    $.getJSON('../mobilecsp-2017/Student.json', function(json) {
      var states = {'Unknown': 0};

      for (i in json.rows) {
        var fields = json.rows[i].additional_fields.split('], [');
        for (j in fields) {
          if (fields[j].indexOf('zipcode') > -1) {
            zipcode = fields[j].split(',')[1].split('"')[1];
            var usState = zipToState(zipcode);
            if (usState) {
              if (!states[usState]) {
                states[usState] = 0;
              }
              states[usState] += 1;
            } else {
              states.Unknown += 1;
            }
          }
        }
      }

      createMap(states);
    });

    function createMap(states) {
      var map = L.map('map', {
          center: [39, -98],
          zoom: 4
      });

      var max = 1;
      var keys = Object.keys(states);
      for (k in keys) {
        if (states[keys[k]] > max) max = states[keys[k]];
      }

      var Stamen_TonerLite = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', {
      	attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      	subdomains: 'abcd',
      	minZoom: 0,
      	maxZoom: 20,
      	ext: 'png'
      }).addTo(map);

      /*
      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map); */

      function getColor(d) {
        if (d == 1) d = 0.99;
        var colors = ['f1eef6', 'bdc9e1', '74a9cf', '2b8cbe', '045a8d'];
        return '#' + colors[parseInt(d*5)];
      }

      function style(feature) {
        var val = states[feature.properties.NAME];
        if (!val) val = 0;
        return {color: getColor(val/max), stroke: 0, fillOpacity: 0.8};
      }

      function onEachFeature(feature, layer) {
        var name = layer.feature.properties.NAME;
        var val = states[name];
        if (!val) val = 0;

        layer.bindPopup('<b>' + name + '</b> ' + val);
        //layer.on('mouseover', function() { layer.openPopup(); });
        //layer.on('mouseout', function() { layer.closePopup(); });
      }


      $.getJSON('us-states.geojson', function(data) {
        var usMap = new L.geoJSON(data, {
          style: style,
          onEachFeature: onEachFeature,
        }).addTo(map);
      });

    }

    </script>
  </body>

</html>
